<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV BUILDER</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>CSV BUILDER</h1>
            <div style="display: flex; align-items: center; gap: 10px; justify-content: center;">
                <p>Create product CSV files with metadata</p>
                <button class="help-btn" onclick="toggleHelp('builderHelp')" style="position: static;">?</button>
            </div>
            <div class="help-text" id="builderHelp" style="display: none; margin-top: 15px; text-align: left;">
                <p><strong>WHAT IS THE CSV BUILDER?</strong></p>
                <p>The CSV Builder helps you create a CSV file with product metadata (SKU, names, prices, sales data) that matches your product images.</p>
                <p><strong>HOW IT WORKS:</strong></p>
                <p>1. Upload your product images - filenames are automatically extracted</p>
                <p>2. Add metadata for each product (SKU, name, price, etc.)</p>
                <p>3. Optionally add price and performance history</p>
                <p>4. Export the CSV file</p>
                <p>5. Use this CSV file in the main app when uploading products</p>
                <p><strong>WHY USE IT?</strong> The CSV Builder ensures your filenames match perfectly and makes it easy to add metadata without manually creating a CSV file.</p>
            </div>
            <a href="/" class="btn-link">← BACK TO APP</a>
        </header>

        <main>
            <!-- Progress -->
            <div class="progress-steps">
                <div class="progress-step active" data-step="1">
                    <span class="step">1</span>
                    <span>UPLOAD</span>
                </div>
                <div class="progress-step" data-step="2">
                    <span class="step">2</span>
                    <span>METADATA</span>
                </div>
                <div class="progress-step" data-step="3">
                    <span class="step">3</span>
                    <span>HISTORY</span>
                </div>
                <div class="progress-step" data-step="4">
                    <span class="step">4</span>
                    <span>EXPORT</span>
                </div>
            </div>

            <!-- Step 1: Upload -->
            <section class="section" id="step1" style="display: block;">
                <div class="section-header">
                    <h2>STEP 1: UPLOAD IMAGES</h2>
                    <button class="help-btn" onclick="toggleHelp('step1Help')">?</button>
                </div>
                <div class="help-text" id="step1Help" style="display: none; margin-bottom: 20px;">
                    <p><strong>HOW TO UPLOAD:</strong></p>
                    <p>1. Click "BROWSE" or drag and drop a folder</p>
                    <p>2. Select a folder containing your product images</p>
                    <p>3. Images can be in subfolders (categories will be auto-detected)</p>
                    <p>4. Supported formats: JPG, PNG, WebP</p>
                    <p><strong>WHAT HAPPENS:</strong> The builder will extract filenames from your images and create a table where you can add metadata for each product.</p>
                </div>

                <div class="upload-box">
                    <div class="drop-zone" id="imageDropZone">
                        <p>DROP FOLDER HERE</p>
                        <button class="btn" id="imageBrowseBtn">BROWSE</button>
                        <input type="file" id="imageInput" webkitdirectory directory multiple hidden>
                    </div>
                    <div class="file-info" id="imageInfo"></div>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" id="nextToMetadata" disabled>NEXT →</button>
                </div>
            </section>

            <!-- Step 2: Metadata -->
            <section class="section" id="step2" style="display: none;">
                <div class="section-header">
                    <h2>STEP 2: ADD METADATA</h2>
                    <button class="help-btn" onclick="toggleHelp('step2Help')">?</button>
                </div>
                <div class="help-text" id="step2Help" style="display: none; margin-bottom: 20px;">
                    <p><strong>FILL IN PRODUCT DETAILS:</strong></p>
                    <p>• <strong>Filename:</strong> Auto-filled from your images (don't change this!)</p>
                    <p>• <strong>Category:</strong> Auto-detected from folders or enter manually</p>
                    <p>• <strong>SKU:</strong> Unique product identifier (optional)</p>
                    <p>• <strong>Name:</strong> Descriptive product name (optional)</p>
                    <p>• <strong>Price:</strong> Current price (optional)</p>
                    <p><strong>BULK EDIT:</strong> Use the tools above the table to apply values to multiple products at once. Select products with checkboxes first.</p>
                    <p><strong>PASTE FROM EXCEL:</strong> Copy data from Excel and paste it directly into the table!</p>
                </div>

                <div class="bulk-panel">
                    <h3>BULK EDIT</h3>
                    <div class="bulk-controls">
                        <div class="bulk-group">
                            <label>CATEGORY:</label>
                            <input type="text" id="bulkCategory" placeholder="e.g., placemats">
                            <button class="btn" onclick="applyBulkEdit('category')">APPLY</button>
                        </div>
                        <div class="bulk-group">
                            <label>PRICE:</label>
                            <input type="number" id="bulkPrice" placeholder="29.99" step="0.01" min="0">
                            <button class="btn" onclick="applyBulkEdit('price')">APPLY</button>
                        </div>
                        <div class="bulk-group">
                            <button class="btn" onclick="selectAll()">SELECT ALL</button>
                            <button class="btn" onclick="deselectAll()">DESELECT</button>
                            <button class="btn" onclick="pasteFromExcel()">PASTE</button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="productsTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>
                                <th>FILENAME</th>
                                <th>CATEGORY</th>
                                <th>SKU</th>
                                <th>NAME</th>
                                <th>PRICE</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                        </tbody>
                    </table>
                </div>

                <div class="actions">
                    <button class="btn" onclick="goToStep(1)">← BACK</button>
                    <button class="btn" onclick="saveDraft()">SAVE</button>
                    <button class="btn" onclick="loadDraft()">LOAD</button>
                    <button class="btn btn-primary" onclick="goToStep(3)">NEXT →</button>
                </div>
            </section>

            <!-- Step 3: History -->
            <section class="section" id="step3" style="display: none;">
                <div class="section-header">
                    <h2>STEP 3: PRICE & PERFORMANCE</h2>
                    <button class="help-btn" onclick="toggleHelp('step3Help')">?</button>
                </div>
                <div class="help-text" id="step3Help" style="display: none; margin-bottom: 20px;">
                    <p><strong>ADD HISTORICAL DATA (OPTIONAL):</strong></p>
                    <p><strong>Price History:</strong> Track how prices changed over time (up to 12 months). Add date and price for each entry.</p>
                    <p><strong>Performance History:</strong> Track sales metrics including:</p>
                    <p>• Sales volume (units sold)</p>
                    <p>• Page views</p>
                    <p>• Conversion rate (%)</p>
                    <p>• Revenue ($)</p>
                    <p><strong>WHY ADD THIS?</strong> Historical data enables trend charts, analytics, and performance comparisons in the main app.</p>
                    <p><strong>TIP:</strong> You can skip this step if you only need basic matching.</p>
                </div>

                <div class="selector">
                    <label>SELECT PRODUCT:</label>
                    <select id="productSelector" onchange="loadProductHistory()">
                        <option value="">-- SELECT --</option>
                    </select>
                    <span id="productProgress"></span>
                </div>

                <div id="historyEditor" style="display: none;">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('price')">PRICE</button>
                        <button class="tab" onclick="switchTab('performance')">PERFORMANCE</button>
                    </div>

                    <!-- Price Tab -->
                    <div class="tab-panel active" id="priceTab">
                        <div class="controls">
                            <button class="btn" onclick="addPriceEntry()">+ ADD</button>
                            <button class="btn" onclick="importPriceFromClipboard()">IMPORT</button>
                            <button class="btn" onclick="clearPriceHistory()">CLEAR</button>
                        </div>
                        <div class="entries" id="priceEntries">
                            <p class="empty">No price history. Click "ADD" to start.</p>
                        </div>
                    </div>

                    <!-- Performance Tab -->
                    <div class="tab-panel" id="performanceTab">
                        <div class="controls">
                            <button class="btn" onclick="addPerformanceEntry()">+ ADD</button>
                            <button class="btn" onclick="importPerformanceFromClipboard()">IMPORT</button>
                            <button class="btn" onclick="clearPerformanceHistory()">CLEAR</button>
                        </div>
                        <div class="entries" id="performanceEntries">
                            <p class="empty">No performance history. Click "ADD" to start.</p>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn" onclick="goToStep(2)">← BACK</button>
                    <button class="btn" onclick="skipHistory()">SKIP</button>
                    <button class="btn btn-primary" onclick="goToStep(4)">NEXT →</button>
                </div>
            </section>

            <!-- Step 4: Export -->
            <section class="section" id="step4" style="display: none;">
                <div class="section-header">
                    <h2>STEP 4: EXPORT CSV</h2>
                    <button class="help-btn" onclick="toggleHelp('step4Help')">?</button>
                </div>
                <div class="help-text" id="step4Help" style="display: none; margin-bottom: 20px;">
                    <p><strong>EXPORT YOUR CSV FILE:</strong></p>
                    <p>1. Review the preview to make sure everything looks correct</p>
                    <p>2. Choose your export options (headers, separator, etc.)</p>
                    <p>3. Click "DOWNLOAD CSV" to save the file</p>
                    <p><strong>NEXT STEPS:</strong></p>
                    <p>1. Go back to the main app</p>
                    <p>2. Upload your product images (same images you used here)</p>
                    <p>3. Upload this CSV file in the "Advanced Mode" section</p>
                    <p>4. The filenames will match automatically!</p>
                </div>

                <div class="export-options">
                    <h3>OPTIONS</h3>
                    <div class="option">
                        <label>
                            <input type="checkbox" id="includeHeaders" checked>
                            INCLUDE HEADERS
                        </label>
                    </div>
                    <div class="option">
                        <label>SEPARATOR:</label>
                        <select id="separatorSelect">
                            <option value=",">COMMA</option>
                            <option value="\t">TAB</option>
                            <option value=";">SEMICOLON</option>
                        </select>
                    </div>
                    <div class="option">
                        <label>
                            <input type="checkbox" id="includeEmptyFields">
                            INCLUDE EMPTY
                        </label>
                    </div>
                </div>

                <div class="preview">
                    <h3>PREVIEW</h3>
                    <div class="preview-controls">
                        <button class="btn" onclick="refreshPreview()">REFRESH</button>
                        <span id="previewStats"></span>
                    </div>
                    <pre id="csvPreviewContent"></pre>
                </div>

                <div class="actions">
                    <button class="btn" onclick="goToStep(3)">← BACK</button>
                    <button class="btn btn-primary" onclick="downloadCSV()">DOWNLOAD</button>
                    <button class="btn" onclick="copyToClipboard()">COPY</button>
                    <button class="btn" onclick="saveAsTemplate()">SAVE TEMPLATE</button>
                </div>
            </section>
        </main>
    </div>

    <div id="toast" class="toast"></div>

    <script src="/static/csv-builder.js"></script>
</body>
</html>
